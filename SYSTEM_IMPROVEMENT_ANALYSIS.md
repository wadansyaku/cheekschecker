# Cheekschecker ã‚·ã‚¹ãƒ†ãƒ æ”¹å–„åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025-10-27
**åˆ†æå¯¾è±¡**: Cheekschecker è‡ªå‹•ç›£è¦–ãƒ»é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

Cheekscheckerã¯ã€äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç›£è¦–ã—ã¦å¥³æ€§å‚åŠ è€…ã®çŠ¶æ³ã‚’Slackã«é€šçŸ¥ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚æœ¬ãƒ¬ãƒãƒ¼ãƒˆã§ã¯ã€ç¾çŠ¶ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’æ‰¹åˆ¤çš„ã«åˆ†æã—ã€å„ªå…ˆé †ä½ä»˜ãã®å»ºè¨­çš„ãªæ”¹å–„ææ¡ˆã‚’æä¾›ã—ã¾ã™ã€‚

### ä¸»ãªç™ºè¦‹äº‹é …

**å¼·ã¿**:
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–ã®è¨­è¨ˆï¼ˆãƒã‚¹ã‚­ãƒ³ã‚°æˆ¦ç•¥ï¼‰
- robots.txtæº–æ‹ ã«ã‚ˆã‚‹å€«ç†çš„ãªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
- å …ç‰¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹
- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

**æ”¹å–„ãŒå¿…è¦ãªé ˜åŸŸ**:
- ã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘åº¦ï¼ˆå¤§ããªé–¢æ•°ã€è¤‡æ•°ã®è²¬ä»»ï¼‰
- å‹å®‰å…¨æ€§ã®æ¬ å¦‚ï¼ˆCI/CDã§ã®å‹ãƒã‚§ãƒƒã‚¯æœªå®Ÿæ–½ï¼‰
- ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã®ä¸è¶³
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ†é›¢ä¸è¶³

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ç›®çš„ã¨æ©Ÿèƒ½

Cheekscheckerã¯ä»¥ä¸‹ã®ä¸»è¦æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™:

1. **ç›£è¦–æ©Ÿèƒ½**: 10åˆ†é–“éš”ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¥³æ€§å‚åŠ è€…æ•°ãŒåŸºæº–ã‚’æº€ãŸã™æ—¥ã‚’æ¤œå‡º
2. **é€šçŸ¥æ©Ÿèƒ½**: åŸºæº–é”æˆæ™‚ã«Slackã¸Block Kitå½¢å¼ã§é€šçŸ¥
3. **é›†ç´„æ©Ÿèƒ½**: é€±æ¬¡ãƒ»æœˆæ¬¡ã§ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã—ã€ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚’æä¾›

### 1.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **è¨€èª**: Python 3.11+
- **ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: playwright (ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–), beautifulsoup4 (HTMLè§£æ), requests (HTTP)
- **CI/CD**: GitHub Actions
- **å¤–éƒ¨é€£æº**: Slack Incoming Webhooks

### 1.3 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
GitHub Actions (ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ)
    â†“
watch_cheeks.py (ç›£è¦–ãƒ»è§£æãƒ»é€šçŸ¥)
    â”œâ”€ fetch_calendar_html() [Playwright]
    â”œâ”€ parse_day_entries() [BeautifulSoup]
    â”œâ”€ process_notifications() [çŠ¶æ…‹ç®¡ç†]
    â””â”€ notify_slack() [Slacké€£æº]
    â†“
summarize.py (é›†ç´„ãƒ»åˆ†æ)
    â”œâ”€ build_summary_context() [çµ±è¨ˆè¨ˆç®—]
    â””â”€ build_slack_payload() [Block Kitç”Ÿæˆ]
```

---

## 2. æ‰¹åˆ¤çš„åˆ†æ: ä¸»è¦ãªå•é¡Œç‚¹

### 2.1 ã‚³ãƒ¼ãƒ‰å“è³ªã®å•é¡Œ

#### å•é¡ŒA: å¤§ããªé–¢æ•°ã¨é«˜ã„å¾ªç’°çš„è¤‡é›‘åº¦

**å½±éŸ¿**: ğŸ”´ é«˜ - ä¿å®ˆæ€§ã¨ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã«æ·±åˆ»ãªå½±éŸ¿

**è©³ç´°**:

1. **`parse_day_entries()` (watch_cheeks.py:401-497, 96è¡Œ)**
   - è²¬ä»»: HTMLè§£æã€æ—¥ä»˜æ¨è«–ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã‚«ã‚¦ãƒ³ãƒˆé›†è¨ˆã€åŸºæº–è©•ä¾¡
   - å•é¡Œ: 4å±¤ã®ãƒã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ã€è¤‡æ•°ã®æ¡ä»¶åˆ†å²
   - ãƒ†ã‚¹ãƒˆ: å˜ä¸€ã®å¤§ããªé–¢æ•°ã®ãŸã‚éƒ¨åˆ†çš„ãªãƒ†ã‚¹ãƒˆãŒå›°é›£

2. **`process_notifications()` (watch_cheeks.py:925-1022, 97è¡Œ)**
   - è²¬ä»»: ã‚¨ãƒ³ãƒˆãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€çŠ¶æ…‹é·ç§»è©•ä¾¡ã€Slackãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ§‹ç¯‰ã€é€šçŸ¥é€ä¿¡
   - å•é¡Œ: æ··åœ¨ã—ãŸè²¬å‹™ã«ã‚ˆã‚Šã€å¤‰æ›´ãŒæ³¢åŠã—ã‚„ã™ã„

3. **`build_slack_payload()` (summarize.py:389-551, 162è¡Œ)**
   - è²¬ä»»: Block Kitç”Ÿæˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚­ã‚¹ãƒˆã€ã‚¹ãƒ†ãƒƒãƒ—ã‚µãƒãƒªãƒ¼
   - å•é¡Œ: 9å€‹ä»¥ä¸Šã®ãƒã‚¹ãƒˆã—ãŸãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€æ·±ã„å¤‰æ•°å®šç¾©

**æ¨å¥¨æ”¹å–„ç­–**:

```python
# æ”¹å–„å‰
def parse_day_entries(html, settings, reference_date):
    # 96è¡Œã®å‡¦ç†...
    pass

# æ”¹å–„å¾Œï¼ˆé–¢æ•°åˆ†å‰²ï¼‰
def parse_day_entries(html, settings, reference_date):
    soup = BeautifulSoup(html, "lxml")
    table = _extract_calendar_table(soup)
    rows = _extract_rows(table)
    entries = [_parse_single_entry(row, settings, reference_date) for row in rows]
    return _sort_and_filter(entries)

def _extract_calendar_table(soup):
    # 5-10è¡Œã®å˜ç´”ãªå‡¦ç†
    pass

def _parse_single_entry(row, settings, reference_date):
    # 20-30è¡Œã®å˜ä¸€ã‚¨ãƒ³ãƒˆãƒªè§£æ
    pass
```

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
- å„é–¢æ•°ãŒ10-30è¡Œã«åã¾ã‚‹
- å˜ä½“ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“
- ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒåŠ¹ç‡çš„

---

#### å•é¡ŒB: ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã¨ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

**å½±éŸ¿**: ğŸŸ¡ ä¸­ - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã¨æŸ”è»Ÿæ€§ã«å½±éŸ¿

**è©³ç´°**:

1. **ãƒã‚¹ã‚­ãƒ³ã‚°ã®é™¤ç®—ãƒ­ã‚¸ãƒƒã‚¯** (watch_cheeks.py:732, 735):
```python
# è¡Œ732: ãªãœ3ã§å‰²ã‚‹ã®ã‹èª¬æ˜ãŒãªã„
level2_single = entry.single_female // 3

# è¡Œ735: ãªãœ15ã§å‰²ã‚‹ã®ã‹èª¬æ˜ãŒãªã„
level2_total = entry.total // 15
```

2. **ãƒã‚¹ã‚­ãƒ³ã‚°ãƒãƒ³ãƒ‰ã®å®šç¾©** (watch_cheeks.py:77-106):
   - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸé–¾å€¤ï¼ˆ3-4, 5-6, 7-8ç­‰ï¼‰
   - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ã¹ã

**æ¨å¥¨æ”¹å–„ç­–**:

```python
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: masking_config.json
{
  "single_female_bands": [0, 1, 2, 3, 5, 7, 9],
  "total_bands": [10, 20, 30, 50],
  "level2_divisors": {
    "single": 3,
    "total": 15
  }
}

# ã‚³ãƒ¼ãƒ‰
MASKING_CONFIG = load_masking_config()

def _get_band_label(value: int, bands: List[int]) -> str:
    for i, threshold in enumerate(bands):
        if value < threshold:
            return BAND_LABELS[i]
    return BAND_LABELS[-1]
```

---

#### å•é¡ŒC: å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¬ å¦‚

**å½±éŸ¿**: ğŸŸ¡ ä¸­ - ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ã®ãƒªã‚¹ã‚¯

**è©³ç´°**:

1. **`load_settings()`** (watch_cheeks.py:254-300):
   - ç„¡åŠ¹ãªå…¥åŠ›ã«å¯¾ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™ãŒã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒä¸è¶³
   - strictãƒ¢ãƒ¼ãƒ‰ãŒãªã„

2. **`infer_entry_date()`** (watch_cheeks.py:364-398):
   - ç„¡åŠ¹ãªæœˆç•ªå·ã‚’ã‚¯ãƒ©ãƒ³ãƒ—ã™ã‚‹ãŒã€ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ãªã„

**æ¨å¥¨æ”¹å–„ç­–**:

```python
from pydantic import BaseModel, Field, validator

class Settings(BaseModel):
    target_url: str = Field(..., regex=r'^https?://')
    female_min: int = Field(ge=0, le=100)
    female_ratio_min: float = Field(ge=0.0, le=1.0)
    cooldown_minutes: int = Field(ge=0, le=1440)

    @validator('target_url')
    def validate_url(cls, v):
        if not v.startswith('http'):
            raise ValueError('URLã¯httpã¾ãŸã¯httpsã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™')
        return v
```

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
- è¨­å®šã‚¨ãƒ©ãƒ¼ã®æ—©æœŸç™ºè¦‹
- è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- å‹å®‰å…¨æ€§ã®å‘ä¸Š

---

### 2.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å•é¡Œ

#### å•é¡ŒD: å˜ä¸€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¤‡æ•°è²¬ä»»

**å½±éŸ¿**: ğŸ”´ é«˜ - æ‹¡å¼µæ€§ã¨ä¿å®ˆæ€§ã«æ·±åˆ»ãªå½±éŸ¿

**è©³ç´°**:

`watch_cheeks.py`ãŒä»¥ä¸‹ã®è²¬ä»»ã‚’å…¨ã¦æ‹…å½“:
1. Webã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆPlaywrightåˆ¶å¾¡ï¼‰
2. HTMLè§£æï¼ˆBeautifulSoupï¼‰
3. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¥ä»˜æ¨è«–ã€åŸºæº–è©•ä¾¡ï¼‰
4. çŠ¶æ…‹ç®¡ç†ï¼ˆstate.jsonèª­ã¿æ›¸ãï¼‰
5. é€šçŸ¥ï¼ˆSlack APIå‘¼ã³å‡ºã—ï¼‰
6. ã‚µãƒãƒªãƒ¼ç”Ÿæˆï¼ˆé›†ç´„ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

**æ¨å¥¨æ”¹å–„ç­–**:

```
ç¾åœ¨ã®æ§‹é€ :
watch_cheeks.py (1,284è¡Œ, å…¨è²¬ä»»)

ææ¡ˆã™ã‚‹æ§‹é€ :
src/
  â”œâ”€â”€ fetchers/
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ playwright_fetcher.py   (Webã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°)
  â”‚   â””â”€â”€ robots_checker.py       (robots.txtæ¤œè¨¼)
  â”œâ”€â”€ parsers/
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ calendar_parser.py      (HTMLè§£æ)
  â”‚   â””â”€â”€ date_inference.py       (æ—¥ä»˜æ¨è«–ãƒ­ã‚¸ãƒƒã‚¯)
  â”œâ”€â”€ business/
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ criteria_evaluator.py  (åŸºæº–è©•ä¾¡)
  â”‚   â””â”€â”€ state_machine.py       (é€šçŸ¥çŠ¶æ…‹ç®¡ç†)
  â”œâ”€â”€ storage/
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ state_manager.py       (çŠ¶æ…‹æ°¸ç¶šåŒ–)
  â”‚   â””â”€â”€ history_manager.py     (å±¥æ­´ç®¡ç†)
  â”œâ”€â”€ notifiers/
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ slack_notifier.py      (Slacké€šçŸ¥)
  â”‚   â””â”€â”€ block_builder.py       (Block Kitç”Ÿæˆ)
  â””â”€â”€ orchestrator.py            (å…¨ä½“èª¿æ•´)
```

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
- å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ200-300è¡Œã«åã¾ã‚‹
- å˜ä¸€è²¬ä»»ã®åŸå‰‡ã«æº–æ‹ 
- ä¸¦è¡Œé–‹ç™ºãŒå®¹æ˜“
- ãƒ†ã‚¹ãƒˆã®åˆ†é›¢ãŒæ˜ç¢º

---

#### å•é¡ŒE: çŠ¶æ…‹ç®¡ç†ã®è¤‡é›‘ã•ã¨ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³

**å½±éŸ¿**: ğŸŸ¡ ä¸­ - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒªã‚¹ã‚¯

**è©³ç´°**:

1. **state.json**: å‹•çš„ãªæ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®è¾æ›¸ã€ã‚¹ã‚­ãƒ¼ãƒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—
2. **ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³**: monitorã¨summaryãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒåŒæ™‚ã«`history_masked.json`ã‚’æ›´æ–°
3. **ç·©å’Œç­–**: `git pull --rebase --autostash`ãŒã‚ã‚‹ãŒã€ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ãªã—

**ç¾åœ¨ã®ãƒªã‚¹ã‚¯ã‚·ãƒŠãƒªã‚ª**:
```
æ™‚åˆ» 00:00 - summary_weekly.ymlãŒé–‹å§‹
æ™‚åˆ» 00:01 - monitor.ymlãŒé–‹å§‹
æ™‚åˆ» 00:02 - ä¸¡æ–¹ãŒhistory_masked.jsonã‚’èª­ã¿è¾¼ã¿
æ™‚åˆ» 00:03 - monitor.ymlãŒã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
æ™‚åˆ» 00:04 - summary_weekly.ymlãŒã‚³ãƒŸãƒƒãƒˆè©¦è¡Œ â†’ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆ
æ™‚åˆ» 00:05 - rebaseæˆåŠŸã™ã‚‹ãŒã€monitorã®æ›´æ–°ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§
```

**æ¨å¥¨æ”¹å–„ç­–**:

```yaml
# .github/workflows/monitor.yml
concurrency:
  group: state-update  # å…±é€šã®ã‚°ãƒ«ãƒ¼ãƒ—å
  cancel-in-progress: false

# .github/workflows/summary_weekly.yml
concurrency:
  group: state-update  # åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å
  cancel-in-progress: false
```

ã¾ãŸã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒƒã‚¯:

```python
import fcntl

class StateManager:
    def __init__(self, state_path: Path):
        self.state_path = state_path
        self.lock_path = state_path.with_suffix('.lock')

    def __enter__(self):
        self.lock_file = open(self.lock_path, 'w')
        fcntl.flock(self.lock_file.fileno(), fcntl.LOCK_EX)
        return self

    def __exit__(self, *args):
        fcntl.flock(self.lock_file.fileno(), fcntl.LOCK_UN)
        self.lock_file.close()

# ä½¿ç”¨ä¾‹
with StateManager(Path('state.json')) as manager:
    state = manager.load()
    # å‡¦ç†...
    manager.save(state)
```

---

### 2.3 ãƒ†ã‚¹ãƒˆã¨CI/CDã®å•é¡Œ

#### å•é¡ŒF: å‹ãƒã‚§ãƒƒã‚¯ã®æ¬ å¦‚

**å½±éŸ¿**: ğŸŸ¡ ä¸­ - ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ã®ãƒªã‚¹ã‚¯

**è©³ç´°**:

- ã‚³ãƒ¼ãƒ‰å…¨ä½“ã«å‹ãƒ’ãƒ³ãƒˆãŒå­˜åœ¨ï¼ˆGood!ï¼‰
- ã—ã‹ã—ã€CI/CDã§mypyã‚„pyrightãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„
- å‹ãƒ’ãƒ³ãƒˆã®æ•´åˆæ€§ãŒä¿è¨¼ã•ã‚Œã¦ã„ãªã„

**æ¨å¥¨æ”¹å–„ç­–**:

```yaml
# .github/workflows/test.yml (æ–°è¦ä½œæˆ)
name: Tests and Type Checking

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install mypy pytest pytest-cov

      - name: Type check with mypy
        run: mypy watch_cheeks.py summarize.py --strict

      - name: Run tests with coverage
        run: pytest tests/ --cov=. --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
```

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
- å‹ã®ä¸ä¸€è‡´ã‚’æ—©æœŸç™ºè¦‹
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®å®‰å…¨æ€§å‘ä¸Š
- IDEã®ã‚µãƒãƒ¼ãƒˆå‘ä¸Š

---

#### å•é¡ŒG: çµ±åˆãƒ†ã‚¹ãƒˆã®ä¸è¶³

**å½±éŸ¿**: ğŸŸ¡ ä¸­ - ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®å‹•ä½œä¿è¨¼ãŒå¼±ã„

**è©³ç´°**:

- ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆ: monkeypatchã‚’ä½¿ã£ãŸãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆGood!ï¼‰
- ä¸è¶³: å®Ÿéš›ã®Playwrightã‚’ä½¿ã£ãŸçµ±åˆãƒ†ã‚¹ãƒˆ
- ä¸è¶³: è¤‡é›‘ãªHTMLæ§‹é€ ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆ

**æ¨å¥¨æ”¹å–„ç­–**:

```python
# tests/integration/test_full_flow.py
import pytest
from playwright.async_api import async_playwright

@pytest.mark.integration
async def test_full_scraping_flow():
    """å®Ÿéš›ã®Playwrightã‚’ä½¿ã£ãŸã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ"""
    async with async_playwright() as p:
        browser = await p.chromium.launch()
        # ãƒ†ã‚¹ãƒˆç”¨ãƒ­ãƒ¼ã‚«ãƒ«HTMLã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
        # å®Ÿéš›ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ•ãƒ­ãƒ¼ã‚’æ¤œè¨¼
        pass

@pytest.mark.parametrize("fixture_name", [
    "sample_yoyaku_full.html",
    "sample_yoyaku_empty.html",
    "sample_yoyaku_malformed.html",
    "sample_yoyaku_multibyte.html",
])
def test_parse_various_html_structures(fixture_name):
    """æ§˜ã€…ãªHTMLæ§‹é€ ã«å¯¾ã™ã‚‹è§£æãƒ†ã‚¹ãƒˆ"""
    html = load_fixture(fixture_name)
    entries = parse_day_entries(html)
    # ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³...
```

---

#### å•é¡ŒH: ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã®ä¸è¶³

**å½±éŸ¿**: ğŸŸ¡ ä¸­ - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå›°é›£

**è©³ç´°**:

1. **ãƒ­ã‚°**: ä¸»ã«INFOãƒ¬ãƒ™ãƒ«ã€æ§‹é€ åŒ–ãƒ­ã‚°ãªã—
2. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: è§£æã‚¨ãƒ³ãƒˆãƒªæ•°ã€é€šçŸ¥é€ä¿¡æ•°ãªã©ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãªã—
3. **ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°**: å‡¦ç†æ™‚é–“ã®è¨ˆæ¸¬ãªã—
4. **ã‚¢ãƒ©ãƒ¼ãƒˆ**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã®é€šçŸ¥ãªã—

**æ¨å¥¨æ”¹å–„ç­–**:

```python
import structlog
import time
from contextlib import contextmanager

# æ§‹é€ åŒ–ãƒ­ã‚°ã®å°å…¥
logger = structlog.get_logger()

@contextmanager
def log_duration(operation: str):
    """å‡¦ç†æ™‚é–“ã‚’è¨ˆæ¸¬ã—ãƒ­ã‚°ã«è¨˜éŒ²"""
    start = time.perf_counter()
    try:
        yield
    finally:
        duration = time.perf_counter() - start
        logger.info(
            "operation_completed",
            operation=operation,
            duration_seconds=duration
        )

def parse_day_entries(html, settings, reference_date):
    with log_duration("parse_day_entries"):
        logger.info("parsing_started", html_size=len(html))
        # å‡¦ç†...
        logger.info(
            "parsing_completed",
            entry_count=len(results),
            meets_criteria_count=sum(1 for e in results if e.meets)
        )
        return results
```

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†**:

```python
# metrics.py
from dataclasses import dataclass, field
from typing import Dict

@dataclass
class Metrics:
    counters: Dict[str, int] = field(default_factory=dict)
    timings: Dict[str, float] = field(default_factory=dict)

    def increment(self, name: str, value: int = 1):
        self.counters[name] = self.counters.get(name, 0) + value

    def record_timing(self, name: str, duration: float):
        self.timings[name] = duration

    def to_json(self) -> Dict:
        return {
            "counters": self.counters,
            "timings": self.timings
        }

# ä½¿ç”¨ä¾‹
metrics = Metrics()
metrics.increment("entries_parsed", len(entries))
metrics.increment("notifications_sent", len(stage_notifications))
metrics.record_timing("fetch_duration", fetch_time)

# GitHub Step Summaryã«å‡ºåŠ›
print(f"::notice::Metrics: {json.dumps(metrics.to_json())}")
```

**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—ã‚¢ãƒ©ãƒ¼ãƒˆ**:

```yaml
# .github/workflows/monitor.yml
jobs:
  monitor:
    # ... (æ—¢å­˜ã®è¨­å®š)

  notify-failure:
    runs-on: ubuntu-latest
    needs: monitor
    if: failure()
    steps:
      - name: Notify Slack on failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âŒ Monitor workflow failed",
              "blocks": [{
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "Workflow *${{ github.workflow }}* failed\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
                }
              }]
            }'
```

---

### 2.4 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ï¼ˆè©•ä¾¡: å„ªç§€ï¼‰

#### å¼·ã¿: ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–ã®è¨­è¨ˆ

**è©•ä¾¡**: âœ… å„ªç§€

**è©³ç´°**:

1. **ãƒã‚¹ã‚­ãƒ³ã‚°æˆ¦ç•¥**: ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä¸€åˆ‡ä¿å­˜ã›ãšã€ãƒãƒ³ãƒ‰ãƒ©ãƒ™ãƒ«ã®ã¿
2. **robots.txtæº–æ‹ **: ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã ãŒæœ‰åŠ¹åŒ–
3. **HTMLã‚µãƒ‹ã‚¿ã‚¤ã‚º**: éASCIIæ–‡å­—ã®é™¤å»
4. **3æ—¥é–“ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿æŒ**: ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•å‰Šé™¤

**æ¨å¥¨äº‹é …**: ç¾çŠ¶ç¶­æŒï¼ˆå¤‰æ›´ä¸è¦ï¼‰

---

## 3. å„ªå…ˆé †ä½ä»˜ãæ”¹å–„ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: å³æ™‚å¯¾å¿œï¼ˆ1-2é€±é–“ï¼‰

| å„ªå…ˆåº¦ | æ”¹å–„é …ç›® | å·¥æ•° | æœŸå¾…åŠ¹æœ |
|--------|---------|------|---------|
| ğŸ”´ é«˜ | CI/CDã«å‹ãƒã‚§ãƒƒã‚¯è¿½åŠ  | 2æ™‚é–“ | å‹å®‰å…¨æ€§å‘ä¸Š |
| ğŸ”´ é«˜ | å¤§ããªé–¢æ•°ã‚’åˆ†å‰² | 1é€±é–“ | ä¿å®ˆæ€§ãƒ»ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§å‘ä¸Š |
| ğŸŸ¡ ä¸­ | æ§‹é€ åŒ–ãƒ­ã‚°å°å…¥ | 3æ—¥ | ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åŠ¹ç‡åŒ– |
| ğŸŸ¡ ä¸­ | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—ã‚¢ãƒ©ãƒ¼ãƒˆè¿½åŠ  | 1æ™‚é–“ | éšœå®³æ¤œçŸ¥ã®è¿…é€ŸåŒ– |

**å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:

```bash
# 1. å‹ãƒã‚§ãƒƒã‚¯ã®è¿½åŠ 
pip install mypy
mypy watch_cheeks.py summarize.py --strict

# 2. é–¢æ•°åˆ†å‰²ã®å®Ÿæ–½
# - parse_day_entries()ã‚’5-6å€‹ã®é–¢æ•°ã«åˆ†å‰²
# - process_notifications()ã‚’3-4å€‹ã®é–¢æ•°ã«åˆ†å‰²
# - å„é–¢æ•°ã«å¯¾ã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 

# 3. æ§‹é€ åŒ–ãƒ­ã‚°ã®å°å…¥
pip install structlog
# ãƒ­ã‚¬ãƒ¼ã‚’structlogã«ç½®ãæ›ãˆ

# 4. å¤±æ•—ã‚¢ãƒ©ãƒ¼ãƒˆã®è¿½åŠ 
# - monitor.yml, summary_weekly.yml, summary_monthly.ymlã«
#   notify-failureã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ 
```

---

### Phase 2: çŸ­æœŸæ”¹å–„ï¼ˆ3-4é€±é–“ï¼‰

| å„ªå…ˆåº¦ | æ”¹å–„é …ç›® | å·¥æ•° | æœŸå¾…åŠ¹æœ |
|--------|---------|------|---------|
| ğŸ”´ é«˜ | Slack Block Kitç”Ÿæˆã®ä¸€å…ƒåŒ– | 5æ—¥ | ã‚³ãƒ¼ãƒ‰é‡è¤‡å‰Šæ¸› |
| ğŸŸ¡ ä¸­ | çŠ¶æ…‹ç®¡ç†ã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹å®Ÿè£… | 3æ—¥ | ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³é˜²æ­¢ |
| ğŸŸ¡ ä¸­ | Pydanticã«ã‚ˆã‚‹è¨­å®šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | 3æ—¥ | è¨­å®šã‚¨ãƒ©ãƒ¼ã®æ—©æœŸç™ºè¦‹ |
| ğŸŸ¢ ä½ | ãƒã‚¹ã‚­ãƒ³ã‚°è¨­å®šã®å¤–éƒ¨åŒ– | 2æ—¥ | æŸ”è»Ÿæ€§å‘ä¸Š |

**å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:

```python
# 1. Slack Block Kitä¸€å…ƒåŒ–
# src/notifiers/block_builder.py ã‚’ä½œæˆã—ã€
# watch_cheeks.pyã¨summarize.pyã‹ã‚‰å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’æŠ½å‡º

# 2. çŠ¶æ…‹ç®¡ç†ãƒ­ãƒƒã‚¯
# src/storage/state_manager.pyã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã‚’å®Ÿè£…

# 3. Pydanticãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
# src/config/settings.py ã§Settingsã‚’BaseModelã«å¤‰æ›´

# 4. ãƒã‚¹ã‚­ãƒ³ã‚°è¨­å®šå¤–éƒ¨åŒ–
# config/masking.json ã‚’ä½œæˆã—ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
```

---

### Phase 3: ä¸­æœŸæ”¹å–„ï¼ˆ2-3ãƒ¶æœˆï¼‰

| å„ªå…ˆåº¦ | æ”¹å–„é …ç›® | å·¥æ•° | æœŸå¾…åŠ¹æœ |
|--------|---------|------|---------|
| ğŸ”´ é«˜ | ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²ï¼ˆfetcher, parserç­‰ï¼‰ | 3é€±é–“ | å˜ä¸€è²¬ä»»ã®åŸå‰‡æº–æ‹  |
| ğŸŸ¡ ä¸­ | çµ±åˆãƒ†ã‚¹ãƒˆã®è¿½åŠ  | 1é€±é–“ | ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ä¿è¨¼ |
| ğŸŸ¡ ä¸­ | çŠ¶æ…‹ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°/ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | 1é€±é–“ | ãƒ‡ãƒ¼ã‚¿æå¤±é˜²æ­¢ |
| ğŸŸ¢ ä½ | ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | 2é€±é–“ | ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£å‘ä¸Š |

---

### Phase 4: é•·æœŸãƒ“ã‚¸ãƒ§ãƒ³ï¼ˆ3ãƒ¶æœˆä»¥é™ï¼‰

| å„ªå…ˆåº¦ | æ”¹å–„é …ç›® | å·¥æ•° | æœŸå¾…åŠ¹æœ |
|--------|---------|------|---------|
| ğŸŸ¡ ä¸­ | PostgreSQLãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç§»è¡Œ | 1ãƒ¶æœˆ | ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š |
| ğŸŸ¢ ä½ | Webhookã‚µãƒ¼ãƒãƒ¼å®Ÿè£… | 3é€±é–“ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ |
| ğŸŸ¢ ä½ | Web UIè¿½åŠ  | 1ãƒ¶æœˆ | è¨­å®šç®¡ç†ã®ç°¡æ˜“åŒ– |
| ğŸŸ¢ ä½ | è¤‡æ•°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¯¾å¿œ | 2é€±é–“ | æ©Ÿèƒ½æ‹¡å¼µ |

---

## 4. å…·ä½“çš„ãªæ”¹å–„ä¾‹

### ä¾‹1: parse_day_entries()ã®åˆ†å‰²

**Before** (96è¡Œã®å˜ä¸€é–¢æ•°):
```python
def parse_day_entries(html, settings, reference_date):
    # HTMLè§£æã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã‚«ã‚¦ãƒ³ãƒˆã€åŸºæº–è©•ä¾¡
    # ...96è¡Œ...
    return results
```

**After** (5ã¤ã®å°ã•ãªé–¢æ•°):
```python
def parse_day_entries(
    html: str,
    settings: Settings,
    reference_date: date
) -> List[DailyEntry]:
    """ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼HTMLã‹ã‚‰æ—¥æ¬¡ã‚¨ãƒ³ãƒˆãƒªã‚’è§£æã™ã‚‹

    Args:
        html: è§£æå¯¾è±¡ã®HTML
        settings: è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        reference_date: åŸºæº–æ—¥

    Returns:
        è§£æã•ã‚ŒãŸã‚¨ãƒ³ãƒˆãƒªã®ãƒªã‚¹ãƒˆ
    """
    table = _extract_calendar_table(html)
    if not table:
        return []

    rows = _extract_table_rows(table)
    entries = []

    for row in rows:
        entry = _parse_single_row(row, settings, reference_date)
        if entry:
            entries.append(entry)

    return sorted(entries, key=lambda e: e.business_day)


def _extract_calendar_table(html: str) -> Optional[Tag]:
    """HTMLã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æŠ½å‡º"""
    soup = BeautifulSoup(html, "lxml")
    table = soup.find("table", attrs={"border": "2"})
    if not table:
        LOGGER.warning("Calendar table not found")
    return table


def _extract_table_rows(table: Tag) -> List[Tag]:
    """ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è¡Œã‚’æŠ½å‡º"""
    return table.find_all("tr")


def _parse_single_row(
    row: Tag,
    settings: Settings,
    reference_date: date
) -> Optional[DailyEntry]:
    """å˜ä¸€ã®è¡Œã‹ã‚‰æ—¥æ¬¡ã‚¨ãƒ³ãƒˆãƒªã‚’è§£æ"""
    cells = row.find_all("td")
    if not cells:
        return None

    for cell in cells:
        entry = _parse_cell(cell, settings, reference_date)
        if entry:
            return entry

    return None


def _parse_cell(
    cell: Tag,
    settings: Settings,
    reference_date: date
) -> Optional[DailyEntry]:
    """å˜ä¸€ã®ã‚»ãƒ«ã‹ã‚‰æ—¥æ¬¡ã‚¨ãƒ³ãƒˆãƒªã‚’è§£æ"""
    parts = [part.strip() for part in cell.stripped_strings if part.strip()]
    if not parts:
        return None

    day_of_month = _extract_day_number(parts)
    if not day_of_month:
        return None

    cell_date = infer_entry_date(day_of_month, reference_date)
    content_lines = _extract_content_lines(parts)

    counts = _count_participants(content_lines, settings.exclude_keywords)
    entry = _build_daily_entry(
        cell_date,
        day_of_month,
        counts,
        settings
    )

    return entry


def _extract_day_number(parts: List[str]) -> Optional[int]:
    """ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ãƒ¼ãƒ„ã‹ã‚‰æ—¥ä»˜ç•ªå·ã‚’æŠ½å‡º"""
    for part in parts:
        match = re.search(r"(\d{1,2})", part)
        if match:
            return int(match.group(1))
    return None


def _count_participants(
    lines: List[str],
    exclude_keywords: List[str]
) -> Dict[str, int]:
    """å‚åŠ è€…ã‚’ã‚«ã‚¦ãƒ³ãƒˆ"""
    male_total = female_total = single_total = 0

    for line in lines:
        if _should_exclude_text(line, exclude_keywords):
            continue

        male, female, single = _count_participant_line(line)
        male_total += male
        female_total += female
        single_total += single

    return {
        "male": male_total,
        "female": female_total,
        "single_female": single_total,
        "total": male_total + female_total
    }
```

**æ”¹å–„ã®åŠ¹æœ**:
- å„é–¢æ•°ãŒ10-30è¡Œã«åã¾ã‚‹
- å˜ä½“ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ï¼ˆãƒ¢ãƒƒã‚¯ãŒç°¡å˜ï¼‰
- è²¬ä»»ãŒæ˜ç¢º
- ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒåŠ¹ç‡çš„

---

### ä¾‹2: å‹ãƒã‚§ãƒƒã‚¯ã®è¿½åŠ 

**mypy.ini ã®ä½œæˆ**:
```ini
[mypy]
python_version = 3.11
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
disallow_any_unimported = False
no_implicit_optional = True
warn_redundant_casts = True
warn_unused_ignores = True
warn_no_return = True
check_untyped_defs = True
strict_optional = True
```

**CI/CDã¸ã®çµ±åˆ**:
```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install mypy types-requests types-beautifulsoup4

      - name: Type check
        run: mypy watch_cheeks.py summarize.py

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: pytest tests/ -v --cov=. --cov-report=term-missing
```

---

### ä¾‹3: æ§‹é€ åŒ–ãƒ­ã‚°ã®å°å…¥

**Before**:
```python
import logging
LOGGER = logging.getLogger(__name__)

def fetch_calendar_html(url):
    LOGGER.info(f"Fetching {url}")
    # å‡¦ç†...
    LOGGER.info("Fetch completed")
```

**After**:
```python
import structlog

logger = structlog.get_logger()

def fetch_calendar_html(url: str) -> str:
    logger.info("fetch_started", url=url)

    start_time = time.perf_counter()
    try:
        # å‡¦ç†...
        duration = time.perf_counter() - start_time
        logger.info(
            "fetch_completed",
            url=url,
            duration_seconds=duration,
            html_size=len(html)
        )
        return html
    except Exception as e:
        logger.error(
            "fetch_failed",
            url=url,
            error=str(e),
            error_type=type(e).__name__
        )
        raise
```

**å‡ºåŠ›ä¾‹**:
```json
{
  "event": "fetch_started",
  "url": "http://cheeks.nagoya/yoyaku.shtml",
  "timestamp": "2025-10-27T10:00:00.123456Z"
}
{
  "event": "fetch_completed",
  "url": "http://cheeks.nagoya/yoyaku.shtml",
  "duration_seconds": 2.345,
  "html_size": 12345,
  "timestamp": "2025-10-27T10:00:02.468456Z"
}
```

---

## 5. æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### 5.1 ä¿å®ˆæ€§ã®å‘ä¸Š

| æŒ‡æ¨™ | ç¾åœ¨ | æ”¹å–„å¾Œ | æ”¹å–„ç‡ |
|------|------|--------|--------|
| å¹³å‡é–¢æ•°ã‚µã‚¤ã‚º | 96è¡Œ | 25è¡Œ | 74% æ¸› |
| æœ€å¤§é–¢æ•°ã‚µã‚¤ã‚º | 162è¡Œ | 50è¡Œ | 69% æ¸› |
| å¾ªç’°çš„è¤‡é›‘åº¦ | 15+ | 5ä»¥ä¸‹ | 67% æ¸› |
| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ•° | 2 | 10+ | 5å€ |

### 5.2 å“è³ªã®å‘ä¸Š

| æŒ‡æ¨™ | ç¾åœ¨ | æ”¹å–„å¾Œ |
|------|------|--------|
| å‹ãƒã‚§ãƒƒã‚¯ | ãªã— | å®Œå…¨ |
| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | 70-80% | 90%+ |
| çµ±åˆãƒ†ã‚¹ãƒˆ | ãªã— | ã‚ã‚Š |
| æ§‹é€ åŒ–ãƒ­ã‚° | ãªã— | ã‚ã‚Š |

### 5.3 é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Š

- **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚é–“**: 50% å‰Šæ¸›ï¼ˆå°ã•ãªé–¢æ•°ã«ã‚ˆã‚Šå¤‰æ›´å½±éŸ¿ãŒæ˜ç¢ºï¼‰
- **ãƒã‚°ç™ºè¦‹æ™‚é–“**: 60% å‰Šæ¸›ï¼ˆæ§‹é€ åŒ–ãƒ­ã‚°ã«ã‚ˆã‚‹ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åŠ¹ç‡åŒ–ï¼‰
- **æ–°æ©Ÿèƒ½è¿½åŠ æ™‚é–“**: 40% å‰Šæ¸›ï¼ˆæ˜ç¢ºãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†é›¢ï¼‰

---

## 6. ãƒªã‚¹ã‚¯ã¨ç·©å’Œç­–

### ãƒªã‚¹ã‚¯1: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¸­ã®ãƒã‚°æ··å…¥

**ç·©å’Œç­–**:
- Phase 1ã®å‹ãƒã‚§ãƒƒã‚¯è¿½åŠ ã‚’æœ€å„ªå…ˆ
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰å¾Œã§æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- æ®µéšçš„ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆä¸€åº¦ã«1é–¢æ•°ãšã¤ï¼‰

### ãƒªã‚¹ã‚¯2: CI/CDå®Ÿè¡Œæ™‚é–“ã®å¢—åŠ 

**ç·©å’Œç­–**:
- å‹ãƒã‚§ãƒƒã‚¯ã¨ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œ
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æœ€é©åŒ–
- çµ±åˆãƒ†ã‚¹ãƒˆã¯`@pytest.mark.integration`ã§åˆ†é›¢ã—ã€PRã®ã¿ã§å®Ÿè¡Œ

### ãƒªã‚¹ã‚¯3: çŠ¶æ…‹ç®¡ç†ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã®è¤‡é›‘åŒ–

**ç·©å’Œç­–**:
- ã¾ãšã¯GitHub Actions concurrency groupã§å¯¾å¿œï¼ˆç°¡å˜ï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã¯å¿…è¦ã«å¿œã˜ã¦å¾Œã‹ã‚‰è¿½åŠ 
- è©³ç´°ãªãƒ­ã‚®ãƒ³ã‚°ã§ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã‚’æ¤œçŸ¥

---

## 7. çµè«–

Cheekscheckerã¯ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–ã®è¨­è¨ˆã¨å …ç‰¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã‚ˆã‚Šã€å„ªã‚ŒãŸåŸºç›¤ã‚’æŒã¤ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ã—ã‹ã—ã€ã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘åº¦ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ†é›¢ä¸è¶³ã€ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã®æ¬ å¦‚ã«ã‚ˆã‚Šã€é•·æœŸçš„ãªä¿å®ˆæ€§ã«èª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

æœ¬ãƒ¬ãƒãƒ¼ãƒˆã§ææ¡ˆã—ãŸæ”¹å–„ç­–ã‚’æ®µéšçš„ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®åŠ¹æœãŒæœŸå¾…ã§ãã¾ã™:

1. **ä¿å®ˆæ€§**: å¹³å‡é–¢æ•°ã‚µã‚¤ã‚º74%æ¸›ã€å¾ªç’°çš„è¤‡é›‘åº¦67%æ¸›
2. **å“è³ª**: å‹å®‰å…¨æ€§ã®ç¢ºä¿ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸90%+
3. **é–‹ç™ºåŠ¹ç‡**: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚é–“50%æ¸›ã€ãƒã‚°ç™ºè¦‹æ™‚é–“60%æ¸›
4. **ä¿¡é ¼æ€§**: ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³é˜²æ­¢ã€è©³ç´°ãªã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£

å„ªå…ˆé †ä½ã®é«˜ã„æ”¹å–„ï¼ˆPhase 1, 2ï¼‰ã‹ã‚‰ç€æ‰‹ã—ã€3-6ãƒ¶æœˆã‹ã‘ã¦æ®µéšçš„ã«å®Ÿæ–½ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

---

## ä»˜éŒ²A: ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1 ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆ1-2é€±é–“ï¼‰

- [ ] mypyè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] CI/CDã«å‹ãƒã‚§ãƒƒã‚¯è¿½åŠ 
- [ ] `parse_day_entries()`ã‚’5-6å€‹ã®é–¢æ•°ã«åˆ†å‰²
- [ ] `process_notifications()`ã‚’3-4å€‹ã®é–¢æ•°ã«åˆ†å‰²
- [ ] `build_slack_payload()`ã®åˆ†å‰²æ¤œè¨
- [ ] åˆ†å‰²ã—ãŸé–¢æ•°ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆè¿½åŠ 
- [ ] structlogå°å…¥
- [ ] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—ã‚¢ãƒ©ãƒ¼ãƒˆè¿½åŠ 

### Phase 2 ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆ3-4é€±é–“ï¼‰

- [ ] Slack Block Kitç”Ÿæˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
- [ ] watch_cheeks.pyã¨summarize.pyã‹ã‚‰å…±é€šãƒ­ã‚¸ãƒƒã‚¯æŠ½å‡º
- [ ] GitHub Actions concurrency groupè¨­å®š
- [ ] Pydantic Settingså®Ÿè£…
- [ ] ãƒã‚¹ã‚­ãƒ³ã‚°è¨­å®šJSONä½œæˆ
- [ ] ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸé–¾å€¤ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•

### Phase 3 ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆ2-3ãƒ¶æœˆï¼‰

- [ ] src/fetchers/ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
- [ ] src/parsers/ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
- [ ] src/business/ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
- [ ] src/storage/ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
- [ ] src/notifiers/ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆè¿½åŠ 
- [ ] çŠ¶æ…‹ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å®Ÿè£…
- [ ] ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ¤œè¨

---

## ä»˜éŒ²B: å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

- **Python Type Hints**: https://docs.python.org/3/library/typing.html
- **mypy Documentation**: https://mypy.readthedocs.io/
- **Pydantic**: https://docs.pydantic.dev/
- **structlog**: https://www.structlog.org/
- **pytest Best Practices**: https://docs.pytest.org/en/stable/goodpractices.html
- **Clean Code in Python**: https://testdriven.io/blog/clean-code-python/

---

**ãƒ¬ãƒãƒ¼ãƒˆçµ‚äº†**
